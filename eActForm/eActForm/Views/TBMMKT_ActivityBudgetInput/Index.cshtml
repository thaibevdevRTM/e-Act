@model eActForm.Models.Activity_TBMMKT_Model
@using eActForm.BusinessLayer
@using eActForm.Models
@using System.Configuration;
<link href="~/Content/jquery.datetimepicker.css" rel="stylesheet" />
<script src="~/Scripts/jquery.datetimepicker.full.js"></script>
<script src="~/Scripts/jquery-migrate-1.2.1.min.js"></script>
<script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>

<script src="~/Scripts/dropzone/dropzone.min.js"></script>
<link href="~/Scripts/dropzone/dropzone.min.css" rel="stylesheet" />
<link href="~/Scripts/jquery-ui.css" rel="stylesheet" />
<script src="~/Scripts/jquery-ui.js"></script>
<style>
    .cssTableTDTextCenter {
        max-width: none;
        text-align: center;
        width: 100%;
    }

    .cssTableTDTextLeft {
        max-width: none;
        text-align: left;
        width: 100%;
    }

    .cssTableTDDetailNumber {
        text-align: right;
        width: 100%;
    }
</style>

@using (Ajax.BeginForm("insertDataActivity", "MainForm", new AjaxOptions { HttpMethod = "post", OnBegin = "return beginQuery()", OnSuccess = "successQuery", OnFailure = "failureQuery" }, new { id = "divconditionFlow", @class = "form-horizontal form-label-left" }))
{
    @Html.AntiForgeryToken()
    <div id="GridPDF" style="width:97%; margin-left:20px;">


        <table style="width: 100%;border-style: solid;border-width: 0px 0px 0px 0px; border-collapse: collapse;" id="tabel_report" runat="server">

            <tr>
                <td>
                    @RenderPage("~/Views/TBMMKT_ActivityBudgetInput/headerCompany.cshtml")
                </td>
            </tr>


            @*<tr>
                    <td style="border-style: solid;border-width: 0px 0px 0px 0px; border-collapse: collapse;border-bottom:none;border-left:none;border-right:none;">
                        <div id="divHeadCompany" runat="server" style="width: 100%; align-content: center; text-align: center;">
                            <div id="forDev" style="display:none;">
                                <br />@Html.TextBoxFor(x => x.activityFormModel.id, new { @class = "", @id = "txtActivityId" })
                                <br />@Html.TextBoxFor(x => x.activityFormModel.mode, new { @class = "", @id = "txtmode" })
                            </div>
                        </div>

                    </td>
                </tr>*@

            <tr>
                <td style=" text-align:center;  border-style: solid;border-width: 1px 0px 0px 0px; border-collapse: collapse;border-bottom:none;border-left:none;border-right:none;">

                    <div class="form-group">
                        <div class="col-12  text-center">

                            @*<div class="row text-center"> </div>
                                <div id="divHeadCompany" runat="server" style="width: 100%; align-content: left; text-align: center;">
                            *@  @*@if (Model.activityFormTBMMKT.selectedBrandOrChannel != null)
                                {*@

                            <label class="control-label col-md-1 col-xs-12"></label>
                            <div class="col-md-2  col-xs-12 ">
                                <div style="display:inline-block;">
                                    <label class="control-label" for="ddlRegion">
                                        &nbsp;Condition Flow<span class="required">:&nbsp;</span>
                                    </label>
                                    @Html.DropDownListFor(x => x.activityFormTBMMKT.selectedBrandOrChannel, new SelectList(Model.tB_Act_ActivityForm_SelectBrandOrChannel, "val", "txt", ""), "", new
                                    {
                                        @class = "form-control selectpicker",
                                        id = "ddlChannelOrBrand"
                                    })

                                    <script>
                                    function processDropdownConditionFlow() {
                                        if ($("#ddlChannelOrBrand").val() == "Channel") {
                                            $('#divChannel').css('display', 'inline-block');
                                            $("#divSubject").css('display', 'inline-block');
                                            $("#divBrand").hide();
                                        }
                                        else if ($("#ddlChannelOrBrand").val() == "Brand") {
                                            $('#divBrand').css('display', 'inline-block');
                                            $("#divSubject").css('display', 'inline-block');
                                            $("#divChannel").hide();
                                        }
                                        else {
                                            $("#divBrand").hide();
                                            $("#divChannel").hide();
                                            $("#divSubject").hide();
                                        }
                                    }

                                    $(function () {
                                        //ทำหลังLoadหน้่าเว็บเสร็จ
                                        var p_subjectId = "@Model.tB_Act_ActivityForm_DetailOther.SubjectId";
                                        var p_productBrandId = "@Model.tB_Act_ActivityForm_DetailOther.productBrandId";
                                        var p_channelId = "@Model.tB_Act_ActivityForm_DetailOther.channelId";
                                        if (p_subjectId != "")
                                         {
                                            $("#divSubject").css('display', 'inline-block');
                                            $("#ddlSubject").val(p_subjectId);
                                        }
                                        if (p_productBrandId != "") {
                                            $("#divBrand").css('display', 'inline-block');
                                            $("#ddlBrand").val(p_productBrandId);
                                        }
                                        if (p_channelId != "") {
                                            $("#divChannel").css('display', 'inline-block');
                                            $("#ddlChannel").val(p_channelId);
                                        }
                                        processDropdownConditionFlow();
                                     });

                                    $("#ddlChannelOrBrand").change(function () {
                                        processDropdownConditionFlow();
                                    });
                                    </script>

                                </div>
                            </div>
                            <div class="col-md-2   col-xs-12 ">
                                <div id="divChannel" style="display:block;">
                                    <label class="control-label" for="ddlChannel">
                                        &nbsp;เลือก Channel<span class="required">:&nbsp;</span>
                                    </label>
                                    @Html.DropDownListFor(x => x.activityFormTBMMKT.channelId, new SelectList(Model.tB_Act_Chanel_Model, "id", "chanelGroup", 0), "", new
                                    {
                                        @class = "form-control selectpicker",
                                        id = "ddlChannel"
                                    })
                                </div>
                                <div id="divBrand" style="display:none;">
                                    <label class="control-label" for="ddlBrand">
                                        &nbsp;เลือก Brand<span class="required"></span>
                                    </label>
                                    @Html.DropDownListFor(x => x.activityFormTBMMKT.BrandlId, new SelectList(Model.tB_Act_ProductBrand_Model, "id", "brandName", 0), "", new
                                    {
                                        @class = "form-control selectpicker",
                                        id = "ddlBrand"
                                    })
                                </div>

                            </div>
                            <div class="col-md-4  col-xs-12 ">
                                <div id="divSubject" style="display:block;">
                                    <label class="control-label" for="ddlBrand">
                                        &nbsp;เรื่อง <span class="required"></span>
                                    </label>
                                    @Html.DropDownListFor(x => x.activityFormTBMMKT.SubjectId, new SelectList(Model.tB_Reg_Subject, "id", "nameTH", 0), "", new
                                    {
                                        @class = "form-control selectpicker",
                                        id = "ddlSubject"
                                    })
                                </div>
                                <script>
                    $('#ddlChannel').change(function () {
                        bindDropdownSubject()
                    });
                    $('#ddlBrand').change(function () {
                        bindDropdownSubject()
                    });
                    function bindDropdownSubject() {
                        var valDropdown = '';
                        if ($('#ddlChannelOrBrand').val() == "Channel") {
                            valDropdown = $('#ddlChannel').val();
                        } else {
                            valDropdown = $('#ddlBrand').val();
                        }
                        var dataToBeSend = {
                            idBrandOrChannel: valDropdown
                            , master_type_form_id: "@Model.activityFormTBMMKT.master_type_form_id"
                            , companyId: "@UtilsAppCode.Session.User.empCompanyId"
                        };

                        var ddlSubject = $("#ddlSubject");
                        $.ajax('@Url.Action("GetDataSubjectByChanelOrBrand", "GetDataMainForm")',
                            {
                                contentType: "application/json; charset=utf-8",
                                data: JSON.stringify(dataToBeSend),
                                dataType: 'json',
                                type: "POST",
                                success: function (response) {
                                    if (response.Data.tB_Reg_Subject.length > 0) {
                                        $("#ddlSubject option[value !='']").remove();
                                        $.each(response.Data.tB_Reg_Subject, function () {
                                            ddlSubject.append($("<option></option>").val(this['id']).html(this['nameTH']));
                                        });
                                    }
                                    else {

                                    }
                                },
                                error: function (data) {
                                    alert("Error Get Subject.");
                                }
                            });
                    }
                                </script>
                            </div>
                            <label class="control-label col-md-1 col-xs-12"></label>

                        </div>
                    </div>
                </td>
            </tr>
            <tr style="border: 0px solid black; border-collapse: collapse;border-bottom:none;">
                <td>
                    <div class="row">
                        <div class="col-12">
                            @RenderPage("~/Views/TBMMKT_ActivityBudgetInput/headerDetails.cshtml")
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td style="border-style: solid;border-width: 1px 0px 0px 0px; border-collapse: collapse;border-bottom:none;border-left:none;border-right:none;">
                    <div style="height:5px;"></div>
                    <div style="width: 100%; text-align: left;">
                        @*&nbsp;ค่าใช้จ่ายในการทำกิจกรรม..........................จำนวนเงิน............บาท
                            <br />
                            &nbsp;รายละเอียดงบประมาณ*@
                    </div>
                </td>
            </tr>
            @*<tr style="border-bottom:none;">
                    <td>
                        <div style="height:5px;"></div>
                        @RenderPage("~/Views/TBMMKT_ActivityBudgetInput/activityDetails.cshtml")
                    </td>
                </tr>*@
            <tr style="border-bottom:none;">
                <td>
                    <div style="height:5px;"></div>
                    @RenderPage("~/Views/TBMMKT_ActivityBudgetInput/activityBudgetDetails.cshtml")
                </td>
            </tr>

            <tr>
                <td style="border-style: solid;border-width: 0px 0px 0px 0px; border-collapse: collapse;">
                    @*<div style="height:5px;"></div>
                        <div style="width: 100%; text-align: left;padding-left:15px;">
                            หมายเหตุ @Html.TextAreaFor(x => x.activityFormModel.remark, new { @class = "form-control textboxcss", @id = "txtremark" })
                            cssTableTDTextLeft
                            <br />
                        </div>*@

                    <div style="height:10px;"></div>
                    <div class="form-group">

                        <label class="control-label col-md-2 col-xs-12">
                            หมายเหตุ :
                        </label>

                        <div class="col-md-10 col-xs-12">
                            <div class="row">
                                @Html.TextAreaFor(x => x.activityFormModel.remark, new { @class = "form-control textboxcss", @id = "txtremark" })
                            </div>
                        </div>
                    </div>

                </td>
            </tr>

            <tr style="border-bottom:none;">
                <td>
                    &nbsp;<br /><br />
                </td>
            </tr>


        </table>

    </div>

    @Html.HiddenFor(x => x.activityFormModel.id, new { @id = "hdActivityId" })
    @Html.HiddenFor(x => x.activityFormModel.mode, new { @id = "hdMode" })
    @Html.HiddenFor(x => x.activityFormModel.createdByUserId, new { @id = "hdcreateUser" })
    @Html.HiddenFor(x => x.activityFormTBMMKT.master_type_form_id, new { @id = "hdmaster_type_form_id" })
    @Html.HiddenFor(x => x.activityFormModel.activityNo, new { @id = "hdactivityNo" })
    @Html.HiddenFor(x => x.activityFormTBMMKT.formCompanyId, new { @id = "hdformCompanyId" })
    <div id="divtabelAttachDesc" runat="server" style="width: 97%;border-style: solid;border-width: 0px 0px 0px 0px; margin-left:20px;">
        <div class="form-group">
            <label class="control-label col-md-2 col-xs-12">
                เอกสารแนบ :
            </label>

            <div class="col-md-10 col-xs-12">
                <div class="row">
                    @Html.TextAreaFor(x => x.tB_Act_ActivityForm_DetailOther.descAttach, new { @class = "form-control textboxcss", @id = "txtdescAttach" })
                </div>
            </div>
        </div>
    </div>

}

@RenderPage("~/Views/TBMMKT_ActivityBudgetInput/attachOutFormTag.cshtml")

<div style="height:5px;"></div>


<div style="margin-left:25px;" class="text-center">
    <a href="@Url.Action("index", "Home", new { typeForm = Activity_Model.activityType.TBM.ToString() }, null)" class="btn btn-warning"><i class="fa fa fa-reply fa-fw"></i>&nbsp;Cancel</a>
    @if (Model.activityFormModel.mode == "new" || Model.activityFormTBMMKT.statusId == 1 || Model.activityFormTBMMKT.statusId == 5 || (Model.activityFormModel.mode == "edit" && Model.activityFormTBMMKT.statusId == 2 && UtilsAppCode.Session.User.isAdminTBM))
    {
        <button id="btnsubmit" type="button" class="btn ink-reaction btn-success" onclick="validatesubmit()"><i class="fa fa fa-check fa-fw"></i>&nbsp;Save</button>
    }
</div>





<div class="modal fade" id="previewModal" role="dialog" style="display:none">
    <div id="divPreview">
    </div>
</div>

<script>

       if(('@Model.activityFormTBMMKT.statusId' == '2' && '@UtilsAppCode.Session.User.isAdminTBM' == "False") || ('@Model.activityFormTBMMKT.statusId' == '3'))
        {
           $("#GridPDF :input").prop("disabled", true);
           $("#txtdescAttach").prop("disabled", true);
        }

        if ('@UtilsAppCode.Session.User.isAdminTBM' != 'True') {
            var arrayOfElements = document.getElementsByClassName('clstxtIO');
            var lengthOfArray = arrayOfElements.length;
            for (var i = 0; i < lengthOfArray; i++) {
                arrayOfElements[i].disabled = 'disabled';
            }
        }




    $("#btnExportPDF").click(function () {
        $("input[name='gridHtml']").val($("#GridPDF").html());
        });

    $(function () {
        $("#txtdateDoc").datepicker({ format: '@ConfigurationManager.AppSettings["formatDateUseJquery"]' });
        $("#txtdateActivitySt").datepicker({ format: '@ConfigurationManager.AppSettings["formatDateUseJquery"]' });
        $("#txtactivityPeriodEnd").datepicker({ format: '@ConfigurationManager.AppSettings["formatDateUseJquery"]' });

        });

    function validatesubmit() {

        var required = "กรุณา ระบุ :<br>";
        var validate = true;

        if ($("#ddlChannelOrBrand").val() == "") { required += "Condition Flow*<br>"; validate = false; }
        if ($("#ddlChannel").val() == "" && $("#ddlBrand").val() == "") { required += "BrandหรือChannel*<br>"; validate = false; }
        if ($("#ddlSubject").val() == "") { required += "เรื่อง*<br>"; validate = false; }

        if ($("#txtdateDoc").val() == "") { required += "Document Date*<br>"; validate = false; }
        if ($("#txtactivityTel").val() == "") { required += "เบอร์โทรศัพท์*<br>"; validate = false; }
        if ($("#txtactivityProduct").val() == "") { required += "สินค้า*<br>"; validate = false; }
        if ($("#txtActivityName").val() == "") { required += "ชื่อกิจกรรม*<br>"; validate = false; }
        if ($("#txtEO").val() == "") { required += "EO*<br>"; validate = false; }
        if ($("#txtdateActivitySt").val() == "") { required += "วันที่เริ่มกิจกรรม*<br>"; validate = false; }
        if ($("#txtactivityPeriodEnd").val() == "") { required += "วันที่สิ้นสุดกิจกรรม*<br>"; validate = false; }
        if ($("#txtObjective").val() == "") { required += "วัตถุประสงค์*<br>"; validate = false; }

            if (validate == true) {
                SubmitData();
            }
            else {
                bootbox.alert(required)
            }
        }

    function SubmitData() {
        console.log("submit");
        $("#WaitDialog").show();
        $("#divconditionFlow").submit();

    }

        function beginQuery() {

        }

    function successQuery(data) {
        console.log('success');
        console.log(data);

        $.ajax({
            type: 'POST',
            url: '@Url.Action("Index", "TBMMKT_ActivityBudgetReport")',
            data: { activityId: '@Model.activityFormModel.id' }
        }).done(function (htmlResponse) {

            $.ajax({
                url: '@Url.Action("genPdfApprove", "Documents")',
                data: {
                    GridHtml: htmlResponse,
                    statusId: '',
                    activityId: '@Model.activityFormModel.id',
                },
                dataType: "json",
                type: 'POST',
            }).done(function (response) {
                $("#WaitDialog").hide();
                $("#divPreview").html(htmlResponse)
                $('#previewModal').modal('show');
            });
        });

    }

     function genPdf() {

    }





    function failureQuery(data) {
        console.log('fail');
        console.log(data);
    }


    var fileList = new Array;
    Dropzone.options.dropzoneJsForm = {
        maxFiles: 5,
        acceptedFiles: "",
        paramName: "file",
        maxFilesize: 10,
        //addRemoveLinks: true,
        init: function () {

        this.on("complete", function (file) {
            console.log($("#hdActivityId").val());
            CallImageView($("#hdActivityId").val());

        });
    }

};

function CallImageView(obj) {
    console.log(obj);
        $.ajax({
        type: 'POST',
            url:  '@Url.Action("ImageList", "Activity")',
            data: { activityId: obj}
    }).done(function (htmlResponse) {
            $("#divgetimage").html(htmlResponse)
        });
}

</script>
