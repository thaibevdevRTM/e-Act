@using eActForm.BusinessLayer
@using System.Configuration;
@model eActForm.Models.Activity_TBMMKT_Model



<div class="col-md-12" id="divExpenseCashEmpInfo">
    @*<div style="display:inline-block;"><label>ข้าพเจ้า</label> &nbsp;@Model.TB_Reg_RequestEmp.empName&nbsp;&nbsp;</div>
        <div style="display:inline-block;"><label>ตำแหน่ง </label>&nbsp;@Model.TB_Reg_RequestEmp.position&nbsp;&nbsp;</div>*@

    <div class="col-md-12 col-xs-12 form-group">
        <div class="col-md-6 col-xs-12">
        </div>
        <div class="col-md-3 col-xs-12">
            <div class="control-label pull-right">
                <div id="lblEmpId">รหัสพนักงาน :</div>
            </div>
        </div>
        <div class="col-md-3 col-xs-12">
            @Html.TextBoxFor(x => x.activityFormTBMMKT.empId, new { @class = "form-control textboxcss textRight", Style = "text-align:center;", id = "txtEmpId", onchange = "getEmpDetail();" })
        
        </div>
    </div>

    <div><h4>ข้อมูลพนักงาน</h4></div>
    <hr />
    <div class="col-lg-11 col-xs-12">
        <div class="col-lg-12 col-xs-12" style="margin-top:15px;">
            <div class="col-md-6 col-xs-12">
                <label style="width:80px; text-align:right;">ชื่อ :</label> &nbsp;<lable style="text-align:left" id="lblEmpName"></lable>
            </div>
            <div class="col-md-6 col-xs-12">
                <label style="width:80px; text-align:right;">ตำแหน่ง :</label>&nbsp;<lable style="text-align:left" id="lblEmpPosition"></lable>
            </div>
        </div>

        <div class="col-lg-12 col-xs-12">
            <div class="col-md-6 col-xs-12">
                <label style="width:80px; text-align:right;">ระดับ :</label> &nbsp;<lable style="text-align:left" id="lblLvl" />
            </div>
            <div class="col-md-6 col-xs-12">
                <label style="width:80px; text-align:right;">หน่วยงาน :</label>&nbsp;<lable style="text-align:left" id="lblDept" />
            </div>
        </div>
    </div>
   
</div>

<script type="text/javascript">


    let globAllowance = 0;
    $(document).ready(function () {
        console.log('first')

        $('.datepicker').datepicker({
            format: 'dd/mm/yyyy'
        });
        if ($("#txtEmpId").val() == '') {
            $("#txtEmpId").val('@UtilsAppCode.Session.User.empId');
        }


        getEmpDetail();

        if ('@Model.activityFormTBMMKT.master_type_form_id' == '@ConfigurationManager.AppSettings["masterEmpExpense"]') {

            $("#txtEmpId").autocomplete({
                source: function (request, response) {
                    var channel = $("#ddlChannel").val() == "" ? $("#ddlBrand").val() : $("#ddlChannel").val();
                    $.ajax({
                        url: '@Url.Action("getEmpByChannel", "eAct")',
                        type: "POST",
                        dataType: "json",
                        data: {
                            subjectId: $("#ddlSubject").val(),
                            channelId: channel,
                            filter: $("#txtEmpId").val(),
                        },
                        success: function (data) {
                            response($.map(data, function (item) {
                                return { label: item.empName, value: item.empId, id: item.empId };

                            }))

                        }
                    })
                },
                minLength: 0,
                messages: {
                    noResults: '',
                    results: function (resultsCount) {
                    }
                }, select: function (event, ui) {
                    $("#" + i.id).val(ui.item.id)
                },
                close: function( event, ui ) { getEmpDetail(); }
            }).focus(function () {
                $(this).data("uiAutocomplete").search($(this).val());
            });
        }
    });

    function getEmpDetail() {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("getEmpDetailById", "eAct")',
            data: {
                empId: $("#txtEmpId").val(),
            }
        }).done(function (response) {
            if (response.Data != null) {
                $("#txtEmpName").val(response.Data.empName);
                document.getElementById('lblEmpName').innerHTML = response.Data.empName;
                document.getElementById('lblEmpPosition').innerHTML = response.Data.position;
                document.getElementById('lblLvl').innerHTML = response.Data.level;
                document.getElementById('lblDept').innerHTML = response.Data.department;

                if ('@Model.activityFormTBMMKT.master_type_form_id' == '@ConfigurationManager.AppSettings["masterEmpExpense"]') {
                    getCashEmp(response.Data.level);
                }
            }
            else {
                $("#txtEmpName").val('');
                document.getElementById('lblEmpName').innerHTML = '';
                document.getElementById('lblEmpPosition').innerHTML = '';
                document.getElementById('lblLvl').innerHTML = '';
                document.getElementById('lblDept').innerHTML = '';

            }
        });


    }

    function getCashEmp(lv) {

        console.log('getCashEmp')
        $.ajax({
            type: 'POST',
            url: '@Url.Action("getCashLimitByEmpId", "eAct")',
            data: {
                empId: $("#txtEmpId").val(),
                empLvl: lv,
            }
        }).done(function (response) {

            if (response.Data != null) {

                document.getElementById('ProductDetail_0').innerHTML = response.Data.ProductDetail_0;
                document.getElementById('ProductDetail_1').innerHTML = response.Data.ProductDetail_1;
                $("#ProductDetail_0").val(response.Data.ProductDetail_0);
                $("#ProductDetail_1").val(response.Data.ProductDetail_1);

                document.getElementById('lblBath_0').innerHTML = "บาท/วัน";
                document.getElementById('lblBath_1').innerHTML = "บาท/วัน";
                globAllowance = response.Data.ProductDetail_0;

                //ต้องทำในกรณีที่ไม่ใช่ดึงมาครั้งแรก
                if ($("#txtUnitPrice_0").val() == "" || '@Model.activityFormTBMMKT.id' == "") {
                    $("#txtUnitPrice_0").val(response.Data.ProductDetail_0);
                    $("#txtUnitPrice_1").val(response.Data.ProductDetail_1);
                }
            }
         
        });
    }



</script>
