@model eActForm.Models.Activity_TBMMKT_Model
@using eActForm.BusinessLayer
@using eActForm.Models
<link href="~/Content/jquery.datetimepicker.css" rel="stylesheet" />
<script src="~/Scripts/jquery.datetimepicker.full.js"></script>
<script src="~/Scripts/jquery-migrate-1.2.1.min.js"></script>
<script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>

<script src="~/Scripts/dropzone/dropzone.min.js"></script>
<link href="~/Scripts/dropzone/dropzone.min.css" rel="stylesheet" />
<link href="~/Scripts/jquery-ui.css" rel="stylesheet" />
<script src="~/Scripts/jquery-ui.js"></script>
<style>
    .cssTableTDTextCenter {
        max-width: none;
        text-align: center;
        width: 100%;
    }

    .cssTableTDTextLeft {
        max-width: none;
        text-align: left;
        width: 100%;
    }

    .cssTableTDDetailNumber {
        text-align: right;
        width: 100%;
    }
</style>

@using (Ajax.BeginForm("insertDataActivity", "MainForm", new AjaxOptions { HttpMethod = "post", OnBegin = "return beginQuery()", OnSuccess = "successQuery", OnFailure = "failureQuery" }, new { id = "divconditionFlow", @class = "form-horizontal form-label-left" }))
{
    @Html.AntiForgeryToken()
    <div id="GridPDF" style="width:97%; margin-left:20px;">
        <table style="width: 100%;border-style: solid;border-width: 0px 0px 0px 0px; border-collapse: collapse;" id="tabel_report" runat="server">
            @*=================for test====================*@
            @*<tr>
                <td>
                    @Html.TextBoxFor(x => x.activityFormModel.id, new { @class = "form-control textboxcss", @id = "txtActivityidForTest", style = "" })
                </td>
            </tr>*@
            @*=========END========for test====================*@
            @foreach (var item in Model.master_Type_Form_Detail_Models)
            {
                @Html.Action(item.path_action, item.path_controller, new { activity_TBMMKT_Model = Model })
            }

        </table>
    </div>

    @Html.HiddenFor(x => x.activityFormModel.id, new { @id = "hdActivityId" })
    @Html.HiddenFor(x => x.activityFormModel.mode, new { @id = "hdMode" })
    @Html.HiddenFor(x => x.activityFormModel.createdByUserId, new { @id = "hdcreateUser" })
    @Html.HiddenFor(x => x.activityFormTBMMKT.master_type_form_id, new { @id = "hdmaster_type_form_id"})
}

@RenderPage("~/Views/TBMMKT_ActivityBudgetInput/attachOutFormTag.cshtml")

<div style="height:5px;">

</div>

<div style="margin-left:25px;" class="text-center">
    <a href="@Url.Action("index", "Home", new { typeForm = Activity_Model.activityType.TBM.ToString() }, null)" class="btn btn-warning"><i class="fa fa fa-reply fa-fw"></i>&nbsp;Cancel</a>
    @if (Model.activityFormModel.mode == "new" || Model.activityFormTBMMKT.statusId == 1 || Model.activityFormTBMMKT.statusId == 5 || (Model.activityFormModel.mode == "edit" && Model.activityFormTBMMKT.statusId == 2 && UtilsAppCode.Session.User.isAdminTBM))
    {
        <button id="btnsubmit" type="button" class="btn ink-reaction btn-success" onclick="validatesubmit()"><i class="fa fa fa-check fa-fw"></i>&nbsp;Save</button>
    }
</div>


<div class="modal fade" id="previewModal" role="dialog" style="display:none">
    <div id="divPreview">
    </div>
</div>

<script>

       if(('@Model.activityFormTBMMKT.statusId' == '2' && '@UtilsAppCode.Session.User.isAdminTBM' == "False") || ('@Model.activityFormTBMMKT.statusId' == '3'))
        {
           $("#GridPDF :input").prop("disabled", true);
           $("#txtdescAttach").prop("disabled", true);
        }

        if ('@UtilsAppCode.Session.User.isAdminTBM' != 'True') {
            var arrayOfElements = document.getElementsByClassName('clstxtIO');
            var lengthOfArray = arrayOfElements.length;
            for (var i = 0; i < lengthOfArray; i++) {
                arrayOfElements[i].disabled = 'disabled';
            }
        }




    $("#btnExportPDF").click(function () {
        $("input[name='gridHtml']").val($("#GridPDF").html());
        });

    $(function () {
        $("#txtdateDoc").datepicker();
        $("#txtdateActivitySt").datepicker();
        $("#txtactivityPeriodEnd").datepicker();

        });

    function validatesubmit() {

        var required = "กรุณา ระบุ :<br>";
        var validate = true;

        if ($("#ddlChannelOrBrand").val() == "") { required += "Condition Flow*<br>"; validate = false; }
        if ($("#ddlChannel").val() == "" && $("#ddlBrand").val() == "") { required += "BrandหรือChannel*<br>"; validate = false; }
        if ($("#ddlSubject").val() == "") { required += "เรื่อง*<br>"; validate = false; }

        if ('@Model.activityFormTBMMKT.master_type_form_id' == "8C4511BA-E0D6-4E6F-AD8D-62A5431E4BD4") {
            if ($("#txtdateDoc").val() == "") { required += "Document Date*<br>"; validate = false; }
            if ($("#txtActivityName").val() == "") { required += "ชื่องาน*<br>"; validate = false; }
            if ($("#txtdateActivitySt").val() == "") { required += "ต้องการเช็ควันที่*<br>"; validate = false; }
            if ($("#txtactivityPeriodEnd").val() == "") { required += "เคลียร์เงินทดรองในวันที่*<br>"; validate = false; }
            if ($("#txtObjective").val() == "") { required += "วัตถุประสงค์*<br>"; validate = false; }
        }
        else if ('@Model.activityFormTBMMKT.master_type_form_id' == "24BA9F57-586A-4A8E-B54C-00C23C41BFC5") {//ใบเบิกผลิตภัณฑ์,POS/PREMIUM
            if ($("#ddlin_or_out_stock").val() == "") { required += "ประเภทสต๊อก*<br>"; validate = false; }
            var v_select_tB_Act_master_list_choice_id = "";
            $('#ddlproduct_pos_premium option:selected').each(function () {
                v_select_tB_Act_master_list_choice_id += ($(this).val() + "|");
            });
            v_select_tB_Act_master_list_choice_id = v_select_tB_Act_master_list_choice_id.substring(0, (v_select_tB_Act_master_list_choice_id.length - 1))
            if (v_select_tB_Act_master_list_choice_id == "") { required += "ขอเบิก*<br>"; validate = false; }
            if ($("#ddlfor").val() == "") { required += "เพื่อ*<br>"; validate = false; }
            if ($("#ddlbrand_select").val() == "") { required += "Brand/ผลิตภัณฑ์*<br>"; validate = false; }
            if ($("#ddlchannel_place").val() == "") { required += "Channel+Region*<br>"; validate = false; }
            if ($("#txttoName").val() == "") { required += "ให้แก่(ชื่อผู้รับ)*<br>"; validate = false; }
            if ($("#txtObjective").val() == "") { required += "วัตถุประสงค์ที่ขอเบิก*<br>"; validate = false; }
        }
        else {

        }

            if (validate == true) {
                SubmitData();
            }
            else {
                bootbox.alert(required)
            }
        }

    function SubmitData() {
        console.log("submit");
        $("#WaitDialog").show();
        $("#divconditionFlow").submit();

    }

        function beginQuery() {

        }

    function successQuery(data) {
        console.log('success');
        console.log(data);

        $.ajax({
            type: 'POST',
            url: '@Url.Action("Index", "MainReport")',
            data: { activityId: '@Model.activityFormModel.id' }
        }).done(function (htmlResponse) {

            $.ajax({
                url: '@Url.Action("genPdfApprove", "Documents")',
                data: {
                    GridHtml: htmlResponse,
                    statusId: '',
                    activityId: '@Model.activityFormModel.id',
                },
                dataType: "json",
                type: 'POST',
            }).done(function (response) {
                $("#WaitDialog").hide();
                $("#divPreview").html(htmlResponse)
                $('#previewModal').modal('show');
            });
        });

    }

     function genPdf() {

    }





    function failureQuery(data) {
        console.log('fail');
        console.log(data);
    }


    var fileList = new Array;
    Dropzone.options.dropzoneJsForm = {
        maxFiles: 5,
        acceptedFiles: "",
        paramName: "file",
        maxFilesize: 10,
        //addRemoveLinks: true,
        init: function () {

        this.on("complete", function (file) {
            console.log($("#hdActivityId").val());
            CallImageView($("#hdActivityId").val());

        });
    }

};

function CallImageView(obj) {
    console.log(obj);
        $.ajax({
        type: 'POST',
            url:  '@Url.Action("ImageList", "Activity")',
            data: { activityId: obj}
    }).done(function (htmlResponse) {
            $("#divgetimage").html(htmlResponse)
        });
}

</script>
