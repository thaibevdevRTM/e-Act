@using eActForm.Models
@using eActForm.BusinessLayer
@using System.Configuration;
@model eActForm.Models.Activity_Model.actForms

<div class="row">

    <div class="col-md-12 col-xs-12">
        <a class="btn ink-reaction btn-info fa fa-search" href="#"></a>คือ View
        <a class="btn ink-reaction btn-success fa fa-thumbs-o-up" href="#"></a>คือ Approve
    </div>
    <div class="col-md-12 col-xs-12">


        <table id="datatable" class="table table-striped table-hover">
            <thead>
                <tr style="background-color:#2B5D95;color:#ffffff;">
                    @if (UtilsAppCode.Session.User.empCompanyId == ConfigurationManager.AppSettings["companyId_MT"])
                    {
                        <th width="20">
                            <input type="checkbox" id="chk_All" class="icheckbox_flat-green" onchange="setFlagAll(this);" name="table_records">
                        </th>

                        <th>
                            <a class="btn ink-reaction btn-success fa fa-thumbs-o-up" style="width:150px; height:35px" onclick="submitApprove();"> Approve </a>
                        </th>
                    }
                    else
                    {
                        <th></th>
                    }
                    <th>Status</th>
                    <th>Doc.Date</th>
                    <th>Act.No</th>
                    <th>วัตถุประสงค์</th>
                    <th align="center">ยอดขายช่วงกิจกรรม</th>
                    <th align="center">ค่าใช้จ่าย</th>
                    <th align="center">% ต่อยอดขาย</th>
                    <th align="center">createBy</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.actLists)
                {
                    <tr class="gradeX">
                        @if (UtilsAppCode.Session.User.empCompanyId == ConfigurationManager.AppSettings["companyId_MT"])
                        {
                            <td class="a-center ">

                                <input type="checkbox" id="chk_@item.id" class="icheckbox_flat-green" value="@item.id" name="chk_approve">

                            </td>
                        }
                        <td>
                            @Html.ActionLink(" ", "getPDF", "ActivityViewer", new { actId = item.id, type = AppCode.ApproveType.Activity_Form.ToString() }, new { @class = "btn ink-reaction btn-info fa fa-search", target = "_blank" })
                            <a onclick="callApproveList('@item.id');">
                                <i class="btn ink-reaction btn-dark fa fa-eye"></i>
                            </a>
                            @Html.ActionLink(" ", "index", "approve", new { actId = item.id, type = AppCode.ApproveType.Activity_Form }, new { @class = "btn ink-reaction btn-success fa fa-thumbs-o-up" })
                        </td>
                        <td>@item.statusName</td>
                        <td>@{var date = item.documentDate == null ? "" : item.documentDate.Value.ToString("dd/MM/yyyy");} @date </td>
                        <td>@item.activityNo</td>
                        <td>@item.objective</td>
                        <td align="center">@string.Format("{0:n2}", item.themeCost)</td>
                        <td align="center">@string.Format("{0:n2}", @item.totalCost)</td>
                        <td align="center">
                            @string.Format("{0:n2}", @item.perTotal)
                        </td>
                        <td>@item.createByUserName</td>
                    </tr>
                }
            </tbody>
        </table>

    </div>

</div>


<div class="modal fade" id="ModalPreviewPDF" style="display:none">
    <div id="divPreviewApprove">

    </div>
</div>
<input id="dataFromAct" type="hidden" />
<script>
    $(document).ready(function () {
        $('#datatable').DataTable({
            "columnDefs": [
                { "orderable": false, "targets": 0 }
                , { "orderable": false, "targets": 1 }
                , { "orderable": false, "targets": 2 }
                , { "orderable": false, "targets": 3 }
            ],
            "dom": 'lCfrtip',
            "order": [],
            "language": {
                "lengthMenu": '_MENU_ entries per page',
                "search": '<i class="fa fa-search"></i>',
                "paginate": {
                    "previous": '<i class="fa fa-angle-left"></i>',
                    "next": '<i class="fa fa-angle-right"></i>'
                }
            }
        });

    })

    function setFlagAll(ele) {
        var chkAll = ele.checked ? true : false;
        $("input[name='chk_approve']:checkbox").prop('checked', chkAll);
    }

    function submitApprove() {
        var favorite = [];
        $.each($("input[name='chk_approve']:checked"), function () {
            favorite.push($(this).val());
            console.log(favorite[favorite.length-1]);
            insertApprove(favorite[favorite.length - 1]);
        }).promise().done(function () {
           bootbox.confirm({
                message: "ดำเนินการเรียบร้อยครับ",
                buttons: {
                    confirm: {
                        label: 'OK',
                        className: 'btn-success'
                    }
                },
                callback: function (result) {

                    var url = '@Url.Action("Index", "ApproveLists")';
                    window.location.replace(url);// = url;

                }
            });
        });
    }

    function insertApprove(actId) {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("insertApproveList", "ApproveLists")',
            data: {
                actId: actId,
                status: '3',
                approveType:'@AppCode.ApproveType.Activity_Form',
            }
        }).done(function (result) {
            callPreviewApprove(actId)
        });
    }

    function callPreviewApprove(actId) {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("previewApprove", "Approve")',
            data: {
                actId: actId,
                typeForm: '@AppCode.ApproveType.Activity_Form.ToString()',
            }
        }).done(function (htmlResponse) {
            $("#dataFromAct").val(htmlResponse);
            sentApprove_GenPdf(actId);
        });
    }

    function sentApprove_GenPdf(actId) {
        $.ajax({
            url: '@Url.Action("doApprove", "ApiApprove")',
            data: {
                GridHtml: $("#dataFromAct").val(),
                statusId: '3',
                activityId: actId,
            },
            dataType: "json",
            type: 'POST',
        }).done(function (response) {

        });
    }


    function callApproveList(actId) {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("approveLists", "Home")',
            data: {
                actId: actId
            }
        }).done(function (response) {
            $("#divPreviewApprove").html(response)
            $('#ModalPreviewPDF').modal('show');
        });
    }
</script>