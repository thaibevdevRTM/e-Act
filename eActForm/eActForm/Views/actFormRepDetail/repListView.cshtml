@using eActForm.Models
@using System.Configuration
@using eActForm.BusinessLayer
@model eActForm.Models.RepDetailModel.actFormRepDetails



<div class="modal-dialog modal-large">
    <!-- Modal content-->
    <div class="modal-content">
        <div class="modal-header">
            <div style=""></div>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div id="divPDF" class="tabcontent">
            <div class="modal-body">
                <div id="GridPDF" class="row" style="background-color:white;">
                    @if (Model.actFormRepDetailGroupLists != null && Model.actFormRepDetailGroupLists.Count > 0)
                    {
                        <div class="col-md-12 col-xs-12">
                            <table>
                                <tr>
                                    <td>
                                        บริษัท โมเดิร์นเทรดแมนเนจเม้นท์ จำกัด
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        รายละเอียดขออนุมัติงบประมาณจัดกิจกรรมด้านส่งเสริมการขาย  @Model.actFormRepDetailLists[0].cusNameTH
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        ประจำเดือน @ViewBag.MouthText
                                    </td>
                                </tr>
                            </table>

                            <table id="datatable" border="0" style="text-align:center;font-family:Angsana New;font-size:10pt;" class="table table-striped table-bordered dt-responsive nowrap">
                                <thead>
                                    <tr style="background-color:#2B5D95;color:#ffffff;text-align:center;">
                                        <th rowspan="3">ลำดับที่</th>
                                        <th rowspan="3" width="80px" style="text-align:center;">เลขที่ Activity</th>
                                        <th rowspan="3" width="100px" style="text-align:center;">ชื่อลูกค้า</th>
                                        <th rowspan="3" style="text-align:center;">reference</th>
                                        <th colspan="2" rowspan="2">ระยะเวลากิจกรรม</th>
                                        <th colspan="2" rowspan="2">ระยะเวลาให้ทุน</th>
                                        <th rowspan="3" width="120px" style="text-align:center;">ชื่อสินค้า</th>
                                        <th rowspan="3">ขนาด</th>
                                        <th rowspan="3" width="100px" style="text-align:center;">รายละเอียดกิจกรรม</th>
                                        <th rowspan="2">กลุ่มกิจกรรม</th>
                                        <th rowspan="3">Special Discount (Pro Deal)</th>
                                        <th rowspan="3">Compensate (CN)</th>
                                        <th colspan="2" width="100px">ประมาณการยอดขาย</th>
                                        <th rowspan="3">%Growth</th>
                                        <th rowspan="3">%SE</th>
                                        <th rowspan="3">ประมาณการค่าใช้จ่าย</th>
                                        <th rowspan="3">%Sale</th>
                                        <th rowspan="3">หมายเหตุ</th>
                                    </tr>

                                    <tr style="background-color:#2B5D95;color:#ffffff;text-align:center;">
                                        <th>ยอดขายก่อนจัดกิจกรรม</th>
                                        <th>ยอดขายช่วงจัดกิจกรรม</th>
                                    </tr>
                                    <tr style="background-color:#2B5D95;color:#ffffff;text-align:center;">
                                        <th width="50px">วันเริ่มต้น</th>
                                        <th width="50px">วันสิ้นสุด</th>
                                        <th width="50px">วันเริ่มต้น</th>
                                        <th width="50px">วันสิ้นสุด</th>
                                        <th>14 กลุ่ม</th>
                                        <th>กล่อง</th>
                                        <th>กล่อง</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    @{ var index = 1; string strActNo = "", strActDetail = ""; decimal? sumTotal = 0, sumNormalSale = 0, sumNormalPromotion = 0;}
                                    @foreach (var item in Model.actFormRepDetailGroupLists)
                                    {
                                        if (item.delFlag == false)
                                        {
                                            <tr class="gradeX">

                                                @if (item.activityNo == strActNo)
                                                {
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                }
                                                else
                                                {
                                                    <td>@index</td>
                                                    <td>@item.activityNo</td>
                                                    <td>@item.cusNameTH</td>
                                                    <td>@item.reference</td>
                                                    if (item.activityPeriodSt != null)
                                                    {
                                                        <td>@item.activityPeriodSt.Value.ToString("dd/MM/yyyy")</td>
                                                    }
                                                    else
                                                    {
                                                        <td></td>
                                                    }
                                                    if (item.activityPeriodEnd != null)
                                                    {
                                                        <td>@item.activityPeriodEnd.Value.ToString("dd/MM/yyyy")</td>
                                                    }
                                                    else
                                                    {
                                                        <td></td>
                                                    }
                                                    if (item.costPeriodSt != null)
                                                    {
                                                        <td>@item.costPeriodSt.Value.ToString("dd/MM/yyyy")</td>
                                                    }
                                                    else
                                                    {
                                                        <td></td>
                                                    }
                                                    if (item.costPeriodEnd != null)
                                                    {
                                                        <td>@item.costPeriodEnd.Value.ToString("dd/MM/yyyy")</td>
                                                    }
                                                    else
                                                    {
                                                        <td></td>
                                                    }
                                                    index++;
                                                }

                                                <td>@item.productName</td>
                                                <td>@item.size</td>
                                                @if (item.activityDetail == strActDetail && item.activityNo == strActNo)
                                                {
                                                    <td></td>
                                                }
                                                else
                                                {
                                                    <td>@Html.Raw(item.activityDetail.Replace("\n", "<br/>").Replace("\r\n", "<br/>"))</td>
                                                }



                                                <td>@item.theme</td>
                                                <td>@{ var discount = (item.specialDiscBaht == 0) ? item.specialDisc : item.specialDiscBaht; } @string.Format("{0:n2}", discount)</td>
                                                <td>@string.Format("{0:n2}", item.compensate)</td>
                                                <td>@string.Format("{0:n2}", item.normalSale)</td>
                                                <td>@string.Format("{0:n2}", item.promotionSale)</td>
                                                <td>@string.Format("{0:n2}", item.perGrowth)</td>
                                                <td>@string.Format("{0:n2}", item.perSE)</td>
                                                <td>@string.Format("{0:n2}", item.total)</td>
                                                <td>@string.Format("{0:n2}", item.perToSale)</td>
                                                <td></td>
                                            </tr>
                                            strActDetail = item.activityDetail;
                                            strActNo = item.activityNo;

                                            sumTotal = sumTotal + item.total;
                                            sumNormalSale = item.normalSale == 0 ? sumNormalSale : sumNormalSale + item.normalSale;
                                            sumNormalPromotion = item.promotionSale == 0 ? sumNormalPromotion : sumNormalPromotion + item.promotionSale;

                                        }
                                    }

                                    <tr>
                                        <td colspan="13" style="text-align:right;background-color:#a3d5cf"><h4>รวม : </h4></td>
                                        <td></td>
                                        <td><h5>@string.Format("{0:n2}", sumNormalSale)</h5></td>
                                        <td><h5>@string.Format("{0:n2}", sumNormalPromotion)</h5></td>
                                        <td></td>
                                        <td></td>
                                        <td><h5> @string.Format("{0:n2}", sumTotal)</h5></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>


                    }
                    @if (UtilsAppCode.Session.User.isAdmin || UtilsAppCode.Session.User.isSuperAdmin)
                    {
                        <div class="row">
                            <div class="col-md-12 col-xs-12">
                                <div class="pull-right" style="margin-right:10px;">
                                    @if (Model.actFormRepDetailGroupLists != null && Model.actFormRepDetailGroupLists.Count > 0)
                                    {
                                        @Html.Action("approvePositionSignature", "actFormRepDetail", new { flowModel = Model.flowList })
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="row">
                    @if ((UtilsAppCode.Session.User.isAdmin || UtilsAppCode.Session.User.isSuperAdmin) && Model.actFormRepDetailGroupLists[0].productTypeId == ConfigurationManager.AppSettings["productTypeIdNonAlcho"])
                    {
                        // nonAlcho
                        // product oisih ,jubjai (9F0725DB-29CC-4569-86C4-3F96724BCB87,7E58F57F-1790-467B-8DA8-90BB7BE5C137)
                        <div id="divOS">
                            @Html.Action("repListViewGroupBrand", "actFormRepDetail", new { model = Model, brandId = new string[] { "1D8F1409-9A19-46AC-B1D3-D71919351716", "32459970-AACE-4E67-B58B-F6D786F8D7A1" } })
                        </div>
                        <div id="divEst">
                            @Html.Action("repListViewGroupBrand", "actFormRepDetail", new { model = Model, brandId = new string[] { "9EC1CA68-591D-4B3A-9A65-6509C6ED965E", "6B623E91-AE6E-4621-A6CD-3F567D19BC70" } })
                        </div>
                        <div id="divWA">
                            @Html.Action("repListViewGroupBrand", "actFormRepDetail", new { model = Model, brandId = new string[] { "3B936397-55EC-475B-9441-5BE7DE1F80F5", "2395EA4D-5CD5-4DDB-A7B6-48EF819B99BB" } })
                        </div>
                        <div id="divSO">
                            @Html.Action("repListViewGroupBrand", "actFormRepDetail", new { model = Model, brandId = new string[] { "7CA5340A-747B-486C-81C5-D206B081D96A", "BB57DBF4-C281-4F79-9481-2B8A4C53C723" } })
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">

                    <div class="col-md-2 col-xs-12">
                        <div class="pull-right">
                            @using (Html.BeginForm("repListViewExportExcel", "actFormRepDetail", FormMethod.Post))
                            {
                                <input type="hidden" name="gridHtml" />
                                <button type="submit" class="btn ink-reaction btn-success" id="btnExportExcel" value="ExportExcel">
                                    <i class="fa fa-file-excel-o"></i>&nbsp;Export To Excel
                                </button>
                            }
                        </div>
                    </div>
                    <div class="col-md-2 col-xs-12">
                        <div class="center-block">
                            @using (Html.BeginForm("repListViewExportPDF", "actFormRepDetail", FormMethod.Post))
                            {
                                <input type="hidden" name="gridHtml" />
                                <button type="submit" class="btn ink-reaction btn-success" id="btnExportPDF" value="ExportPDF">
                                    <i class="fa fa-file-excel-o"></i>&nbsp;Export To PDF
                                </button>
                            }
                        </div>
                    </div>
                    <div class="col-md-offset-3 col-md-2 col-xs-12">
                        <div>
                            @if (UtilsAppCode.Session.User.isAdmin || UtilsAppCode.Session.User.isSuperAdmin)
                            {
                                <button type="button" class="btn ink-reaction btn-primary" id="btnSubmitPDF" value="Export" style="width:100%;">
                                    <i class="fa check-square-o"></i>&nbsp;Send to Approve
                                </button>
                            }
                        </div>
                    </div>
                    <div class="col-md-2 col-xs-12">
                        <div>
                            <button type="button" class="btn ink-reaction btn-warning" data-dismiss="modal">
                                <i class="fa fa fa-reply fa-fw"></i>&nbsp;Cancel
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>


    </div>
</div>

<script type="text/javascript">





    $(function () {
                $("#btnExportExcel").click(function () {
                    $("input[name='gridHtml']").val($("#GridPDF").html());
                });

                 $("#btnExportPDF").click(function () {
                     $("input[name='gridHtml']").val($("#GridPDF").html());
                 });
    });

            $(function () {
                $("#btnSubmit").click(function () {
                    $("#previewModal").modal('hide');
                    $("#WaitDialog").show();
                    $.ajax({
                        url: '@Url.Action("repReportDetailApprove", "actFormRepDetail")',
                        data: {
                            gridHtml: $("#Grid").html(),
                            gridOs: $("#divOS").html(),
                            gridEst: $("#divEst").html(),
                            gridWA: $("#divWA").html(),
                            gridSO: $("#divSO").html(),
                            customerId: $("#ddlCustomer").val(),
                            productTypeId: $("#ddlProductType").val(),
                            startDate: $("#startDate").val(),
                            endDate: $("#endDate").val(),
                            typeForm:"@Model.typeForm",
                        },
                        dataType: "json",
                        type: 'POST'
                    }).done(function (response) {
                        $("#WaitDialog").hide();
                        if (response.Success) {
                            doMsgSuccess("ดำเนินการเรียบร้อยครับ");
                            $("#chooseRepDetailView").html("");
                            }
                            else {
                            doMsgFail("ไม่สามารถดำเนินการได้สำเร็จ กรุณาติดต่อ Admin ครับ");
                            }
                    });
                });
            });



    $(function () {
                $("#btnSubmitPDF").click(function () {
                    $("#previewModal").modal('hide');
                    $("#WaitDialog").show();
                    $.ajax({
                        url: '@Url.Action("repReportDetailApprove", "actFormRepDetail")',
                        data: {
                            gridHtml: $("#GridPDF").html(),
                            gridOs: $("#divOS").html(),
                            gridEst: $("#divEst").html(),
                            gridWA: $("#divWA").html(),
                            gridSO: $("#divSO").html(),
                            customerId: $("#ddlCustomer").val(),
                            productTypeId: $("#ddlProductType").val(),
                            startDate: $("#startDate").val(),
                            endDate: $("#endDate").val(),
                            typeForm: "@Model.typeForm",
                        },
                        dataType: "json",
                        type: 'POST'
                    }).done(function (response) {
                        $("#WaitDialog").hide();
                        if (response.Success) {
                            doMsgSuccess("ดำเนินการเรียบร้อยครับ");
                            $("#chooseRepDetailView").html("");
                            }
                            else {
                            doMsgFail("ไม่สามารถดำเนินการได้สำเร็จ กรุณาติดต่อ Admin ครับ");
                            }
                    });


                });
            });
</script>