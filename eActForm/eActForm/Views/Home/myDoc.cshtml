@using eActForm.Models
@using eActForm.BusinessLayer
@using System.Configuration;
@model eActForm.Models.Activity_Model.actForms

<script>

    function checkBeforeDelete(actId, statusId) {
        chkInvoiceBeforeDel(actId, statusId);
    }

    function checkDelete(actId, statusId) {
        var msg = "";
        if (statusId == "1"
            ||
            (statusId == "6" && ("@UtilsAppCode.Session.User.isAdminOMT.ToString().ToLower()" == "true"
                || "@UtilsAppCode.Session.User.isAdmin.ToString().ToLower()" == "true"
                || "@UtilsAppCode.Session.User.isSuperAdmin.ToString().ToLower()" == "true"))
            ||
            (statusId == "5" && ("@UtilsAppCode.Session.User.empCompanyId" == "3030"
                || "@UtilsAppCode.Session.User.empCompanyId" == "4800"
                || "@UtilsAppCode.Session.User.isAdminOMT.ToString().ToLower()" == "true"
                || "@UtilsAppCode.Session.User.isAdmin.ToString().ToLower()" == "true"
                || "@UtilsAppCode.Session.User.isAdminTBM.ToString().ToLower()" == "true"
                || "@UtilsAppCode.Session.User.isAdminHCM.ToString().ToLower()" == "true"
                || "@UtilsAppCode.Session.User.isSuperAdmin.ToString().ToLower()" == "true")))
        {
            // can be delete
            msg = "คุณต้องการยกเลิกเอกสารนี้หรือไม่?"
        }
        else {
            // can't delete
            msg = "ระบบจะดำเนินการส่งเรื่องไปยัง Admin เพื่อดำเนินการยกเลิกเอกสารนี้ <br/> ท่านต้องการยกเลิกเอกสารหรือไม่ค่ะ?";
        }

        bootbox.confirm({
            title: "Confirm Message",
            message: msg,
            buttons: {
                confirm: {
                    label: "Yes",
                    className: "btn-success"
                },
                cancel: {
                    label: "No",
                    className: "btn-danger"
                }
            },
            callback: function (result) {
                if (result) {
                    $("#WaitDialog").show();
                    $.ajax({
                        url: '@Url.Action("requestDeleteDoc", "Home")',
                        data: {
                            actId: actId,
                            statusId: statusId,
                        },
                    }).done(function (htmlResponse) {
                        $("#getQuery").html(htmlResponse);
                        $("#WaitDialog").hide();
                        doMsgSuccess("ดำเนินการยกเลิกเอกสารเรียบร้อย")
                    });
                }

            }
        });

    }

    function chkInvoiceBeforeDel(actId, statusId) {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("checkActInvoice", "Home")',
            data: {
                actId: actId
            }
        }).done(function (response) {
            if (response.Success) {
                doMsgFail("เอกสารฉบับนี้ไม่สามารถ ยกเลิกได้ <br/> เนื่องจากเปิด Invoice ไปแล้ว");
                console.log(response.Success);
                return false;
            }
            else {
                checkDelete(actId, statusId);
            }
        });
    }

    function callApproveList(actId) {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("approveLists", "Home")',
            data: {
                actId: actId
            }
        }).done(function (response) {
            $("#divModalApprovelist").html(response)
            $('#modalApprovelist').modal('show');
        });
    }

    function resendApprove(actId) {
        $("#WaitDialog").show();
        $.ajax({
            type: 'POST',
            url:  '@Url.Action("resendApprove", "Base")',
            data: {
                actId: actId
            }
        }).done(function (response) {
            $("#WaitDialog").hide();
            if (response.Success) {
                doMsgSuccess("ดำเนินการเรียบร้อยครับ")
            } else {
                doMsgFail(response.Message);
            }
        });
      }


</script>
<div class="row">

    <div class="col-md-12 col-xs-12">

    </div>
    <div class="col-md-12 col-xs-12">
        <a class="btn ink-reaction glyphicon glyphicon-retweet" href="#"></a>คือ Regen PDF
        <a class="btn ink-reaction btn-danger fa fa-trash-o" href="#"></a>คือ Delete
        <a class="btn ink-reaction btn-info fa fa-edit" href="#"></a>คือ Edit
        <a class="btn ink-reaction btn-success fa fa-search" href="#"></a>คือ View PDF
        <a class="btn ink-reaction btn-dark fa fa-eye" href="#"></a>คือ History Approve
        <a class="btn ink-reaction btn-info fa fa-send-o" href="#"></a>คือ Resend Email

        <table id="datatable" class="table table-striped table-hover">
            <thead>
                <tr style="background-color:#2B5D95;color:#ffffff;">
                    <th width="150" style="text-align:center;">#</th>
                    <th>Status</th>
                    <th>Doc.Date</th>
                    <th>Act.No</th>
                    <th width="150">Act.Name</th>
                    <th>Customer</th>
                    <th>Category</th>
                    <th width="80">Cost</th>
                    <th width="80">Create Date</th>
                    <th width="80">Create By</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.actLists)
                {
                    <tr class="gradeX">
                        <td width="200">
                            @if (UtilsAppCode.Session.User.isAdmin || UtilsAppCode.Session.User.isSuperAdmin)
                            {
                                <a href="javascript:" onclick="return callPreviewApprove('@item.id','@item.statusId','@Model.typeForm','@item.master_type_form_id');">
                                    <i class="btn glyphicon glyphicon-retweet"></i>&nbsp;
                                </a>
                            }
                            @if (item.statusId == "1" || item.statusId == "3" || item.statusId == "5" ||
(item.statusId == "6" && (UtilsAppCode.Session.User.isAdminOMT || UtilsAppCode.Session.User.isAdmin || UtilsAppCode.Session.User.isAdminTBM || UtilsAppCode.Session.User.isSuperAdmin)))
                            {
                                <a href="javascript:" onclick="return checkBeforeDelete('@item.id','@item.statusId');">
                                    <i class="btn ink-reaction btn-danger fa fa-trash-o"></i>&nbsp;
                                </a>
                            }
                            @if (Model.typeForm == Activity_Model.activityType.MT.ToString())
                            {
                                @Html.ActionLink(" ", "ActivityForm", "Activity", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.MT.ToString() }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            else if (Model.typeForm == Activity_Model.activityType.OMT.ToString())
                            {
                                @Html.ActionLink(" ", "ActivityForm", "Activity", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.OMT.ToString() }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            else if (Model.typeForm == Activity_Model.activityType.TBM.ToString() && item.master_type_form_id == "488F7C0D-8B59-4BDE-90E4-F157BFF67829")
                            {
                                @Html.ActionLink(" ", "Index", "TBMMKT_ActivityBudgetInput", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.TBM.ToString(), master_type_form_id = item.master_type_form_id }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            else if (Model.typeForm == Activity_Model.activityType.TBM.ToString() && (item.master_type_form_id == "8C4511BA-E0D6-4E6F-AD8D-62A5431E4BD4" || item.master_type_form_id == "294146B1-A6E5-44A7-B484-17794FA368EB"))
                            {
                                @Html.ActionLink(" ", "Index", "MainForm", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.TBM.ToString(), master_type_form_id = item.master_type_form_id }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            else if (Model.typeForm == Activity_Model.activityType.TBM.ToString() && item.master_type_form_id == "24BA9F57-586A-4A8E-B54C-00C23C41BFC5") /*ใบเบิกผลิตภัณฑ์,POS / PREMIUM*/
                            {
                                @Html.ActionLink(" ", "Index", "MainForm", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.TBM.ToString(), master_type_form_id = item.master_type_form_id }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            else if (Model.typeForm == Activity_Model.activityType.HCM.ToString() && (item.master_type_form_id == "B4F405D7-8AAF-4B03-8AFB-3EC8F292AA90"))
                            {
                                @Html.ActionLink(" ", "Index", "MainForm", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.HCM.ToString(), master_type_form_id = item.master_type_form_id }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            else if (Model.typeForm == Activity_Model.activityType.HCM.ToString() && (item.master_type_form_id == "D3741442-EAD8-40F6-9A94-339DA65C0428"))
                            {
                                @Html.ActionLink(" ", "Index", "MainForm", new { activityId = item.id, mode = Activity_Model.modeForm.edit, typeForm = Activity_Model.activityType.HCM.ToString(), master_type_form_id = item.master_type_form_id }, new { @class = "btn ink-reaction btn-info fa fa-edit", onclick = "waitpopup();", })
                            }
                            @if (item.statusId == "2" || item.statusId == "3")
                            {
                                @Html.ActionLink(" ", "getPDF", "ActivityViewer", new { actId = item.id, type = AppCode.ApproveType.Activity_Form.ToString() }, new { @class = "btn ink-reaction btn-success fa fa-search", target = "_blank" })
                            }

                            <a onclick="callApproveList('@item.id');">
                                <i class="btn ink-reaction btn-dark fa fa-eye"></i>
                            </a>

                            @if (item.statusId == "2")
                            {

                                <a onclick="resendApprove('@item.id');">
                                    <i class="btn ink-reaction btn-info fa fa-send-o"></i>
                                </a>
                            }

                        </td>
                        <td>@item.statusName</td>
                        <td>@{var date = item.documentDate == null ? "" : item.documentDate.Value.ToString("dd/MM/yyyy");} @date </td>
                        <td>@item.activityNo</td>
                        <td>@item.activityName</td>
                        <td>@item.cusShortName</td>
                        <td>@item.productCategory</td>
                        <td>

                            @if (@item.totalCost != 0)
                            {
                                string result = String.Format("{0:n2}", @item.totalCost);
                                @result.ToString();
                            }
                        </td>
                        <td>@{ date = item.createdDate == null ? "" : item.createdDate.Value.ToString("dd/MM/yyyy");} @date</td>
                        <td>@item.createByUserName</td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
</div>
<div class="modal fade" id="modalApprovelist" role="dialog" style="display:none">
    <div id="divModalApprovelist">
    </div>
</div>
<script>
    $(document).ready(function () {
        $('#datatable').DataTable({
            "columnDefs": [
                { "orderable": false, "targets": 0 },
                { "orderable": false, "targets": 3 },
                { "orderable": false, "targets": 4 }
            ],
            "dom": 'lCfrtip',
            "order": [],
            "language": {
                "lengthMenu": '_MENU_ entries per page',
                "search": '<i class="fa fa-search"></i>',
                "paginate": {
                    "previous": '<i class="fa fa-angle-left"></i>',
                    "next": '<i class="fa fa-angle-right"></i>'
                }
            }
        });

    });
    function waitpopup() {
        $("#WaitDialog").show();
    }

    function callPreviewApprove(actId, statusId, typeForm, master_type_form_id) {

        if (master_type_form_id == '488F7C0D-8B59-4BDE-90E4-F157BFF67829') {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Index", "TBMMKT_ActivityBudgetReport")',
                data: {
                    activityId: actId
                }
            }).done(function (htmlResponse) {
                genPdf(actId, statusId, htmlResponse);
            });
        }
        else if (master_type_form_id == '8C4511BA-E0D6-4E6F-AD8D-62A5431E4BD4' || master_type_form_id == '294146B1-A6E5-44A7-B484-17794FA368EB' || master_type_form_id == '24BA9F57-586A-4A8E-B54C-00C23C41BFC5' || master_type_form_id == "B4F405D7-8AAF-4B03-8AFB-3EC8F292AA90" || master_type_form_id == "D3741442-EAD8-40F6-9A94-339DA65C0428") {
             $.ajax({
                type: 'POST',
                url: '@Url.Action("Index", "MainReport")',
                data: {
                    activityId: actId
                }
            }).done(function (htmlResponse) {
                genPdf(actId, statusId, htmlResponse);
            });
        }
        else {
             $.ajax({
                type: 'POST',
                url: '@Url.Action("previewApprove", "Approve")',
                data: {
                    actId: actId
                }
            }).done(function (htmlResponse) {
                genPdf(actId, statusId, htmlResponse);
            });
        }
    }


    function genPdf(actId, statusId, htmlResponse) {
        $.ajax({
            url: '@Url.Action("genPdfApprove", "Documents")',
            data: {
                GridHtml: htmlResponse,
                statusId: statusId,
                activityId: actId,
            },
            dataType: "json",
            type: 'POST',
        }).done(function (response) {
            doMsgSuccess("ดำเนินการเรียบร้อยครับ");
        });
    }




</script>
