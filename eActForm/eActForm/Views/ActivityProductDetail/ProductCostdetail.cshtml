@model eActForm.Models.Activity_Model
@using eActForm.BusinessLayer
@using System.Configuration;
@using eActForm.Models;
@{
    /**/

    /**/
    decimal? promotionTotal = 0;
    ViewBag.Title = "ProductCostdetail";
    Session["promotionTotal"] = 0;


}



<div class="row">
    <div class="col-12">
        <h4>โครงสร้างราคา - ไม่รวม Vat (Product Cost - Bath Per Case)</h4>
    </div>
    <div class="col-12">
        <table class="table table-bordered" id="tbl_productDetail" cellpadding="0" cellspacing="0">
            <thead class="thead-dark">
                <tr>
                    <td class="txtCenter" rowspan="2" width="5%"> <button class="btn ink-reaction btn-danger fa fa-trash-o" onclick="onDelCostDetail();"></button></td>
                    <td class="txtCenter" rowspan="2" style="width:17%;">ชื่อสินค้า (product Name)</td>
                    <td class="txtCenter" rowspan="2" style="width:7%;">Std. Wholesales Price</td>
                    <td class="txtCenter" colspan="2" style="width:15%;">ราคาขาย</td>
                    <td class="txtCenter" colspan="3" style="width:20%;">Normal Discount (Baht)</td>
                    <td class="txtCenter" style="width:7%;">Normal</td>
                    <td class="txtCenter" style="width:7%;">Normal</td>
                    <td class="txtCenter" style="width:7%;">Promotion</td>
                    @if (Model.activityFormModel.typeForm != Activity_Model.activityType.OMT.ToString())
                    {
                        <td id="col_Special" class="txtCenter" colspan="2" style="width:12%;">Special Discount %</td>
                        <td id="col_Promotion" class="txtCenter" style="width:8%;">Promotion</td>
                    }
                </tr>
                <tr>
                    <td class="txtCenter">&nbsp;&nbsp;Normal&nbsp;&nbsp;</td>
                    <td class="txtCenter">Promotion</td>
                    <td class="txtCenter">(1)</td>
                    <td class="txtCenter">(2)</td>
                    <td class="txtCenter">(3)</td>
                    <td class="txtCenter">Cost</td>
                    <td class="txtCenter">GP%</td>
                    <td class="txtCenter">GP%</td>
                    @if (Model.activityFormModel.typeForm != Activity_Model.activityType.OMT.ToString())
                    {
                        <td id="col_DisBaht" class="txtCenter">บาท</td>
                        <td id="col_DisPer" class="txtCenter">&nbsp;&nbsp;&nbsp;%</td>
                        <td id="col_Cost" class="txtCenter">Cost (BHT)</td>
                    }
                </tr>
            </thead>

            @if (Model.productcostdetaillist1 != null)
            {
                var index = 0;
                foreach (var item in Model.productcostdetaillist1)
                {

                    <tr>
                        <td>
                            <button class="btn ink-reaction btn-danger fa fa-trash-o" onclick="onDelCostDetail('@item.productGroupId')"></button>
                            @Html.HiddenFor(model => item.productId, new { @id = "hdProductId_" + index })
                        </td>
                        @if (item.isShowGroup == true)
                        {
                            <td class="font10 textLeft" onclick="showdetail('@item.productGroupId')"><span role="button">@item.brandName @item.size ALL(@item.detailGroup.Count) @item.pack</span></td>
                        }
                        else
                        {
                            if (item.detailGroup.Count >= 1)
                            {

                                <td class="font10 textLeft" onclick="showdetail('@item.productGroupId')"><span role="button">@item.detailGroup[0].productName @item.pack</span></td>

                            }
                        }

                        @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.wholeSalesPrice, "{0:n2}", new { @id = "wholeSalesPrice_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(wholeSalesPrice_" + index + ")" })</td>
                        }
                        else
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.wholeSalesPrice, "{0:n2}", new { @id = "wholeSalesPrice_" + index, @class = "form-control textboxcss font10 textRight", @readonly = true })</td>
                        }

                        <td style="text-align:right">@Html.TextBoxFor(model => item.saleNormal, "{0:n2}", new { @id = "saleNormal_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(saleNormal_" + index + ")" })</td>
                        <td style="text-align:right">@Html.TextBoxFor(model => item.saleIn, "{0:n2}", new { @id = "saleIn_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(saleIn_" + index + ")" })</td>
                        <td style="text-align:right">@Html.TextBoxFor(model => item.disCount1, "{0:n3}", new { @id = "disCount1_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(disCount1_" + index + ")" })</td>
                        <td style="text-align:right">@Html.TextBoxFor(model => item.disCount2, "{0:n3}", new { @id = "disCount2_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(disCount2_" + index + ")" })</td>
                        <td style="text-align:right">@Html.TextBoxFor(model => item.disCount3, "{0:n3}", new { @id = "disCount3_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(disCount3_" + index + ")" })</td>
                        <td style="text-align:right">
                            @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                            {
                                @Html.TextBoxFor(model => item.normalCost, "{0:n2}", new { Style = "background:#c5f0c5;", @id = "normalCost_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")" })
                            }
                            else
                            {
                                @Html.TextBoxFor(model => item.normalCost, "{0:n2}", new { Style = "background:#c5f0c5;", @id = "normalCost_" + index, @class = "form-control textboxcss font10 textRight", @readonly = true })

                            }

                        </td>
                        @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.normalGp, "{0:n2}", new { @id = "normalGp_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")" })</td>
                        }
                        else
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.normalGp, "{0:n2}", new { @id = "normalGp_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @readonly = true })</td>
                        }
                        @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.promotionGp, "{0:n2}", new { @id = "promotionGp_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")" })</td>
                        }
                        else
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.promotionGp, "{0:n2}", new { @id = "promotionGp_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @readonly = true })</td>
                        }
                        @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                        {
                            @Html.HiddenFor(model => item.specialDiscBaht, new { @id = "specialDiscBaht_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(specialDiscBaht_" + index + ")" })
                        }
                        else
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.specialDiscBaht, "{0:n2}", new { @id = "specialDiscBaht_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(specialDiscBaht_" + index + ")" })</td>
                        }

                        @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                        {
                            @Html.HiddenFor(model => item.specialDisc, new { @id = "specialDisc_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(specialDisc_" + index + ")" })
                        }
                        else
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.specialDisc, "{0:n2}", new { @id = "specialDisc_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(specialDisc_" + index + ")" })</td>
                        }

                        @if (Model.activityFormModel.typeForm == Activity_Model.activityType.OMT.ToString())
                        {
                            @Html.HiddenFor(model => item.promotionCost, new { @id = "promotionCost_" + index, @class = "form-control textboxcss font10 textRight", @onchange = "calProductDiscount('" + item.productGroupId + "', " + index + ")", @onfocus = "setZero(promotionCost_" + index + ")" })
                        }
                        else
                        {
                            <td style="text-align:right">@Html.TextBoxFor(model => item.promotionCost, "{0:n2}", new { @id = "promotionCost_" + index, @class = "form-control textboxcss font10 textRight", @readonly = true })</td>
                        }
                    </tr>
                    promotionTotal = item.promotionCost == null ? 0 + promotionTotal : item.promotionCost + promotionTotal;

                    index++;
                }
                Session["promotionTotal"] = promotionTotal;

            }

            <tr>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>

                <td class="auto-style3">&nbsp;</td>
                <td class="auto-style3">&nbsp;</td>
                <td class="auto-style3">&nbsp;</td>
                <td>&nbsp;</td>
                <td class="auto-style4">&nbsp;</td>
                <td class="auto-style4">&nbsp;</td>
                @if (Model.activityFormModel.typeForm != Activity_Model.activityType.OMT.ToString())
                {
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                }

            </tr>
        </table>
    </div>
</div>

<div class="modal fade" id="modalProductDetaillist" role="dialog" style="display:none">
    <div id="divModalProductDetaillist">
    </div>
</div>
<input type="hidden" id="hdPromotionCost" value="@promotionTotal">
<script>

    var rowCount = @Model.productcostdetaillist1.Count;
    function calProductDiscount(id, rowIndex) {
        if ($('#wholeSalesPrice_' + rowIndex).val() != "") {
            var productId = $('#hdProductId_' + rowIndex).val();
            var wholeSalesPrice = $('#wholeSalesPrice_' + rowIndex).val();
            var saleNormal = $('#saleNormal_' + rowIndex).val();
            var saleIn = $('#saleIn_' + rowIndex).val();
            var disCount1 = $('#disCount1_' + rowIndex).val();
            var disCount2 = $('#disCount2_' + rowIndex).val();
            var disCount3 = $('#disCount3_' + rowIndex).val();
            var normalCost = $('#normalCost_' + rowIndex).val();
            var normalGP = $('#normalGp_' + rowIndex).val();
            var promotionGP = $('#promotionGp_' + rowIndex).val();
            var specialDisc = $("#specialDisc_" + rowIndex).val();
            var specialDiscBaht = $("#specialDiscBaht_" + rowIndex).val();

            $.ajax({
            type: 'POST',
            url:  '@Url.Action("calDiscountProduct", "ActivityProductDetail")',
             data: {
                 productGroupId: id,
                 productId: productId,
                 wholeSalesPrice: wholeSalesPrice.replace(",", ""),
                 saleNormal: saleNormal.replace(",", ""),
                 saleIn: saleIn.replace(",", ""),
                 disCount1: disCount1.replace(",", ""),
                 disCount2: disCount2.replace(",", ""),
                 disCount3: disCount3.replace(",", ""),
                 normalCost: normalCost.replace(",", ""),
                 normalGP: normalGP.replace(",", ""),
                 promotionGP: promotionGP.replace(",", ""),
                 specialDisc: specialDisc.replace(",", ""),
                 specialDiscBaht: specialDiscBaht.replace(",", ""),
                 activityId : '@Model.activityFormModel.id',

            }
            }).done(function (response) {


             CallChangefunc('@Model.activityFormModel.id');
        });

        }
    }

    function showdetail(rowId) {
        $.ajax({
            type: 'POST',
            url:  '@Url.Action("showDetailGroup", "ActivityProductDetail")',
            data: {
                rowId: rowId,
                actId: '@Model.activityFormModel.id',
            }
        }).done(function (response) {
            $("#divModalProductDetaillist").html(response)
            $('#modalProductDetaillist').modal('show');
        });
    }


    function onDelCostDetail(id) {

            $.ajax({
            url: '@Url.Action("delCostDetail", "ActivityProductDetail")',
            data: {
                rowid: id,
                id: '@Model.activityFormModel.id',
            },
            dataType: "json",
            type: 'POST',
                success: function (response) {
                    CallChangefunc('@Model.activityFormModel.id');
                    callThemedetailcost('@Model.activityFormModel.id');
                }

            });
    }




</script>

